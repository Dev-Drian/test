{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Agent",
  "description": "Documento de agente. Base por workspace: db_${workspaceId}_agents",
  "type": "object",
  "required": ["_id"],
  "properties": {
    "_id": { "type": "string" },
    "_rev": { "type": "string" },
    "name": { "type": "string" },
    "description": { "type": "string" },
    "workspaceId": { "type": "string", "description": "ID del workspace al que pertenece" },
    "createdBy": { "type": "string" },
    "createdAt": { "type": "string", "format": "date-time" },
    "updatedAt": { "type": "string", "format": "date-time" },
    "type": { "type": "string", "enum": ["private", "public", "key"] },
    "aiModel": {
      "description": "Modelo(s) elegidos por el usuario al crear el agente",
      "oneOf": [
        { "type": "string" },
        { "type": "array", "items": { "type": "string" } }
      ]
    },
    "language": { "type": "string" },
    "tone": { "type": "number", "description": "0=formal, 100=casual" },
    "answer": { "type": "number" },
    "systemPrompt": { 
      "type": "string", 
      "description": "Prompt base del agente. Soporta variables: {{agentName}}, {{agentDesc}}, {{tables}}" 
    },
    "communicationStyle": {
      "type": "object",
      "description": "Configuración del estilo de comunicación",
      "properties": {
        "maxSentences": { "type": "number", "default": 3 },
        "useEmojis": { "type": "boolean", "default": true },
        "greeting": { "type": "string" },
        "farewell": { "type": "string" }
      }
    },
    "responseTemplates": {
      "type": "object",
      "description": "Templates para respuestas comunes. Soporta {{campo}} dinámicos",
      "properties": {
        "createSuccess": { "type": "string", "description": "Mensaje al crear exitosamente" },
        "createConfirm": { "type": "string", "description": "Confirmación antes de crear" },
        "updateSuccess": { "type": "string", "description": "Mensaje al actualizar" },
        "cancelConfirm": { "type": "string", "description": "Confirmación antes de cancelar" },
        "cancelSuccess": { "type": "string", "description": "Mensaje tras cancelar" },
        "missingField": { "type": "string", "description": "Cuando falta un campo requerido" },
        "conflict": { "type": "string", "description": "Cuando hay conflicto de horario/disponibilidad" },
        "notFound": { "type": "string", "description": "Cuando no se encuentra el registro" },
        "error": { "type": "string", "description": "Mensaje de error genérico" }
      }
    },
    "instructions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "title": { "type": "string" },
          "color": { "type": "string" },
          "actions": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "tables": {
      "type": "array",
      "description": "Tablas vinculadas al agente con su tipo de acceso",
      "items": {
        "type": "object",
        "properties": {
          "tableId": { "type": "string", "description": "ID de la tabla" },
          "fullAccess": { "type": "boolean", "default": false, "description": "Si true, ve todos los datos. Si false, filtra por identidad del usuario." }
        },
        "required": ["tableId"]
      }
    },
    "workflows": {
      "type": "array",
      "items": { "type": "string" },
      "description": "IDs de automatizaciones vinculadas"
    },
    "capabilities": {
      "type": "object",
      "description": "Capacidades del agente. Si no se configura, se infiere de las tablas.",
      "properties": {
        "webSearch": { "type": "boolean" },
        "dallEImageGeneration": { "type": "boolean" },
        "codeInterpreter": { "type": "boolean" }
      }
    },
    "businessInfo": {
      "type": "object",
      "description": "Info del negocio (opcional). Si no se pone, usa nombre del agente.",
      "properties": {
        "companyName": { "type": "string", "description": "Nombre de la empresa/negocio" },
        "industry": { 
          "type": "string", 
          "enum": ["clinic", "restaurant", "salon", "veterinary", "retail", "services", "other"],
          "description": "Tipo de negocio (opcional, se infiere de tablas)"
        }
      }
    },
    "limitations": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Cosas que el bot NO puede hacer (opcional). Ej: 'No puedo dar diagnósticos médicos'"
    },
    "engineMode": {
      "type": "string",
      "enum": ["llm-first", "scoring", "legacy"],
      "default": "llm-first",
      "description": "V3: Modo de procesamiento del Engine. llm-first usa Function Calling, scoring usa keywords, legacy usa Chain of Responsibility"
    },
    "vertical": {
      "type": "string",
      "enum": ["healthcare", "retail", "appointments", "general"],
      "default": "general",
      "description": "V3: Vertical de negocio para personalizar prompts automáticamente"
    },
    "toneStyle": {
      "type": "string",
      "enum": ["professional", "friendly", "formal", "empathetic", "concise"],
      "default": "professional",
      "description": "V3: Estilo de tono para las respuestas"
    },
    "fewShotExamples": {
      "type": "array",
      "description": "V3: Ejemplos de conversación para few-shot learning",
      "items": {
        "type": "object",
        "properties": {
          "user": { "type": "string", "description": "Mensaje del usuario de ejemplo" },
          "assistant": { "type": "string", "description": "Respuesta esperada del asistente" }
        },
        "required": ["user", "assistant"]
      }
    },
    "enabledTools": {
      "type": "array",
      "items": { "type": "string" },
      "description": "V3: Lista de tools habilitadas. Si vacío, todas las tools están disponibles"
    },
    "disabledTools": {
      "type": "array",
      "items": { "type": "string" },
      "description": "V3: Lista de tools deshabilitadas para este agente"
    },
    "businessHours": {
      "type": "object",
      "description": "V3: Horario de atención del negocio",
      "properties": {
        "timezone": { "type": "string", "default": "America/Bogota" },
        "schedule": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Horarios por día, ej: { 'lunes_viernes': '09:00-18:00', 'sabado': '09:00-14:00' }"
        },
        "outsideHoursMessage": { "type": "string", "description": "Mensaje cuando se contacta fuera de horario" }
      }
    },
    "customInstructions": {
      "type": "string",
      "description": "V3: Instrucciones adicionales personalizadas para el system prompt"
    }
  }
}
